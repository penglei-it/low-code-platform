# 低代码平台部署说明

本文档说明如何部署低代码平台，让其他人能够访问。

## 部署方式

项目支持多种部署方式，可根据需求选择：

1. **本地网络部署** - 适合局域网内访问
2. **Docker 容器部署** - 推荐用于生产环境
3. **云服务器部署** - 适合互联网访问

---

## 方式一：本地网络部署

### 前置要求

- Node.js >= 18.0.0
- npm >= 9.0.0

### 快速部署

#### Windows 系统

1. **运行生产环境启动脚本**
   ```bash
   启动生产环境.bat
   ```

2. **查看本机 IP 地址**
   ```bash
   ipconfig
   ```
   查找 IPv4 地址，例如：`192.168.1.100`

3. **访问应用**
   - 前端：`http://192.168.1.100:4173`
   - 后端：`http://192.168.1.100:3001`

#### Linux/Mac 系统

1. **添加执行权限**
   ```bash
   chmod +x 启动生产环境.sh
   ```

2. **运行脚本**
   ```bash
   ./启动生产环境.sh
   ```

3. **查看本机 IP 地址**
   ```bash
   ifconfig  # Linux/Mac
   # 或
   ip addr   # Linux
   ```

4. **访问应用**
   - 前端：`http://<本机IP>:4173`
   - 后端：`http://<本机IP>:3001`

### 手动部署步骤

1. **构建前端**
   ```bash
   cd frontend
   npm install
   npm run build
   ```

2. **构建后端**
   ```bash
   cd backend
   npm install
   npm run build
   ```

3. **初始化数据库（首次部署）**
   ```bash
   cd backend
   npx prisma generate
   npx prisma migrate dev --name init
   ```

4. **启动后端**
   ```bash
   cd backend
   npm start
   ```

5. **启动前端预览**
   ```bash
   cd frontend
   npm run preview
   ```

### 使用 PM2 管理（推荐）

PM2 是一个 Node.js 进程管理器，可以保持应用持续运行。

1. **安装 PM2**
   ```bash
   npm install -g pm2
   ```

2. **启动服务**
   ```bash
   # 启动后端
   pm2 start backend/dist/index.js --name "low-code-backend" --env production
   
   # 启动前端预览
   pm2 start npm --name "low-code-frontend" -- run preview --prefix frontend
   ```

3. **保存配置**
   ```bash
   pm2 save
   ```

4. **常用命令**
   ```bash
   pm2 list              # 查看所有进程
   pm2 logs              # 查看日志
   pm2 restart all       # 重启所有进程
   pm2 stop all          # 停止所有进程
   pm2 delete all        # 删除所有进程
   ```

### 防火墙配置

#### Windows

1. 打开"Windows Defender 防火墙"
2. 点击"高级设置"
3. 选择"入站规则" -> "新建规则"
4. 选择"端口" -> 下一步
5. 选择"TCP"，输入端口：`3001, 4173`
6. 选择"允许连接"
7. 完成规则创建

#### Linux

```bash
# Ubuntu/Debian
sudo ufw allow 3001/tcp
sudo ufw allow 4173/tcp

# CentOS/RHEL
sudo firewall-cmd --permanent --add-port=3001/tcp
sudo firewall-cmd --permanent --add-port=4173/tcp
sudo firewall-cmd --reload
```

---

## 方式二：Docker 容器部署

### 前置要求

- Docker >= 20.10
- Docker Compose >= 2.0

### 快速部署

1. **使用 Docker Compose 一键部署**
   ```bash
   docker-compose up -d
   ```

2. **查看服务状态**
   ```bash
   docker-compose ps
   ```

3. **查看日志**
   ```bash
   docker-compose logs -f
   ```

4. **停止服务**
   ```bash
   docker-compose down
   ```

5. **访问应用**
   - 前端：`http://<服务器IP>`
   - 后端：`http://<服务器IP>:3001`

### 自定义配置

编辑 `docker-compose.yml` 文件，可以修改：

- **端口映射**：修改 `ports` 配置
- **环境变量**：在 `environment` 中添加或修改
- **数据持久化**：在 `volumes` 中配置数据目录

### 单独构建和运行

```bash
# 构建后端镜像
cd backend
docker build -t low-code-backend .

# 构建前端镜像
cd frontend
docker build -t low-code-frontend .

# 运行后端容器
docker run -d -p 3001:3001 \
  -v $(pwd)/prisma/dev.db:/app/prisma/dev.db \
  --name low-code-backend \
  low-code-backend

# 运行前端容器
docker run -d -p 80:80 \
  --name low-code-frontend \
  low-code-frontend
```

---

## 方式三：云服务器部署

### 服务器要求

- 操作系统：Ubuntu 20.04+ / CentOS 7+ / Windows Server
- CPU：1 核以上
- 内存：2GB 以上
- 磁盘：20GB 以上

### 部署步骤

1. **连接到服务器**
   ```bash
   ssh username@server-ip
   ```

2. **安装必要软件**
   ```bash
   # Ubuntu/Debian
   sudo apt update
   sudo apt install -y nodejs npm docker.io docker-compose
   
   # CentOS/RHEL
   sudo yum install -y nodejs npm docker docker-compose
   ```

3. **克隆项目**
   ```bash
   git clone <项目地址>
   cd low_coding_platform
   ```

4. **选择部署方式**
   - 使用 Docker Compose（推荐）
   - 使用 PM2 管理

5. **配置域名（可选）**
   - 使用 Nginx 作为反向代理
   - 配置 SSL 证书（Let's Encrypt）

### Nginx 反向代理配置

创建 `/etc/nginx/sites-available/low-code-platform`：

```nginx
server {
    listen 80;
    server_name your-domain.com;

    # 前端
    location / {
        proxy_pass http://localhost:4173;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
    }

    # 后端 API
    location /api {
        proxy_pass http://localhost:3001;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_cache_bypass $http_upgrade;
    }
}
```

启用配置：

```bash
sudo ln -s /etc/nginx/sites-available/low-code-platform /etc/nginx/sites-enabled/
sudo nginx -t
sudo systemctl reload nginx
```

---

## 环境变量配置

### 后端环境变量

创建 `backend/.env` 文件：

```env
PORT=3001
HOST=0.0.0.0
NODE_ENV=production
DATABASE_URL="file:./prisma/dev.db"
OPENAI_API_KEY=your-openai-key
ANTHROPIC_API_KEY=your-anthropic-key
JWT_SECRET=your-secret-key
```

### 前端环境变量

创建 `frontend/.env.production` 文件：

```env
VITE_API_BASE_URL=http://your-server-ip:3001/api
VITE_APP_TITLE=低代码开发平台
VITE_DEBUG=false
VITE_LOG_LEVEL=info
```

**注意**：在生产环境中，请将 `VITE_API_BASE_URL` 设置为实际的后端服务器地址。

---

## 故障排查

### 常见问题

1. **无法访问服务**
   - 检查防火墙设置
   - 确认服务是否正在运行
   - 检查端口是否被占用

2. **数据库连接失败**
   - 确认数据库文件路径正确
   - 检查文件权限
   - 运行 `npx prisma generate` 重新生成客户端

3. **前端无法连接后端**
   - 检查 `VITE_API_BASE_URL` 配置
   - 确认后端服务正常运行
   - 检查 CORS 配置

4. **Docker 容器无法启动**
   - 查看容器日志：`docker-compose logs`
   - 检查端口是否被占用
   - 确认镜像构建成功

### 日志查看

```bash
# PM2 日志
pm2 logs

# Docker 日志
docker-compose logs -f

# 后端日志（直接运行）
cd backend && npm start

# 前端日志（直接运行）
cd frontend && npm run preview
```

---

## 安全建议

1. **使用 HTTPS**
   - 配置 SSL 证书
   - 使用 Let's Encrypt 免费证书

2. **环境变量安全**
   - 不要将敏感信息提交到 Git
   - 使用 `.env` 文件管理配置
   - 在生产环境中使用密钥管理服务

3. **防火墙配置**
   - 仅开放必要端口
   - 使用安全组规则限制访问来源

4. **数据库备份**
   - 定期备份数据库文件
   - 使用自动化备份脚本

---

## 性能优化

1. **使用生产构建**
   - 前端使用 `npm run build` 构建
   - 后端使用 `npm run build` 构建

2. **启用 Gzip 压缩**
   - Nginx 自动支持
   - 在 `nginx.conf` 中已配置

3. **静态资源缓存**
   - Nginx 配置了长期缓存
   - 提高加载速度

4. **使用 CDN**
   - 将静态资源部署到 CDN
   - 减少服务器负载

---

## 更新部署

1. **拉取最新代码**
   ```bash
   git pull
   ```

2. **重新构建**
   ```bash
   npm run build
   ```

3. **重启服务**
   ```bash
   # PM2
   pm2 restart all
   
   # Docker
   docker-compose restart
   ```

---

## 支持

如有问题，请查看：
- 项目 README.md
- GitHub Issues
- 项目文档目录

