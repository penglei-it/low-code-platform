# 数据库集成说明

## 当前状态

已完成的集成工作：

### 1. ✅ Prisma Schema定义

已创建完整的数据库模型定义（`backend/prisma/schema.prisma`），包括：
- Project（项目）
- ApiDefinition（API定义）
- DataModel（数据模型）
- Workflow（工作流定义）
- WorkflowInstance（工作流实例）
- FormDefinition（表单定义）
- FormSubmission（表单提交数据）

### 2. ✅ Prisma Client配置

已创建Prisma Client单例（`backend/src/lib/prisma.ts`）

### 3. ✅ 项目路由更新

已更新 `backend/src/routes/projects.ts` 使用数据库：
- GET `/api/projects` - 从数据库获取所有项目
- GET `/api/projects/:id` - 从数据库获取单个项目
- POST `/api/projects` - 创建项目到数据库
- PUT `/api/projects/:id` - 更新项目到数据库
- DELETE `/api/projects/:id` - 从数据库删除项目
- POST `/api/projects/:id/components` - 保存项目组件到数据库

## 需要完成的工作

### 1. 解决Prisma配置问题

**问题：** Prisma CLI 7.1.0要求使用新的配置方式，但本地安装的Prisma版本可能不同。

**解决方案：**

#### 方案A：使用Prisma 5.x（推荐，更稳定）

```bash
cd backend
npm uninstall prisma @prisma/client
npm install prisma@5.19.1 @prisma/client@5.19.1 --save-exact
npm install better-sqlite3 --save
npx prisma generate
npx prisma migrate dev --name init
```

#### 方案B：使用Prisma 7.x（需要新配置）

1. 保留 `prisma.config.ts` 文件
2. 安装 `prisma` 包（用于配置）：
   ```bash
   npm install prisma --save-dev
   ```
3. 运行迁移：
   ```bash
   npx prisma migrate dev --name init
   ```

### 2. 更新其他路由使用数据库

需要更新的路由：
- [ ] `backend/src/routes/dataModels.ts` - 数据模型路由
- [ ] `backend/src/routes/workflows.ts` - 工作流路由
- [ ] `backend/src/routes/components.ts` - 组件路由（如果需要）

### 3. 创建API定义路由

需要创建新路由：
- [ ] `backend/src/routes/apiDefinitions.ts` - API设计器路由
- [ ] `backend/src/routes/formDefinitions.ts` - 表单设计器路由

## 手动执行步骤

由于Prisma CLI版本问题，请手动执行以下命令：

```bash
# 1. 进入后端目录
cd backend

# 2. 安装Prisma 5.x（稳定版本）
npm uninstall prisma @prisma/client
npm install prisma@5.19.1 @prisma/client@5.19.1 --save-exact
npm install better-sqlite3 --save

# 3. 删除prisma.config.ts（Prisma 5.x不需要）
# （如果存在）

# 4. 生成Prisma Client
npx prisma generate

# 5. 创建数据库迁移
npx prisma migrate dev --name init

# 6. 启动后端服务器测试
npm run dev
```

## 数据库文件位置

SQLite数据库文件将创建在：
- `backend/prisma/dev.db`

## 验证数据库集成

1. **检查数据库文件**：
   - 确认 `backend/prisma/dev.db` 文件已创建

2. **测试API**：
   ```bash
   # 创建项目
   curl -X POST http://localhost:3001/api/projects \
     -H "Content-Type: application/json" \
     -d '{"name":"测试项目","description":"这是一个测试"}'
   
   # 获取项目列表
   curl http://localhost:3001/api/projects
   ```

3. **检查数据库内容**：
   ```bash
   npx prisma studio
   ```
   这将打开Prisma Studio，可以在浏览器中查看和编辑数据库内容。

## 下一步

完成数据库集成后，继续：
1. 更新其他路由使用数据库
2. 为API设计器和表单设计器创建后端路由
3. 更新前端代码调用新的API

