# 持久化存储分析报告

## 概述

本报告分析了项目中所有配置项和开发项目的持久化存储情况，评估了当前实现的问题和改进建议。

## 当前持久化情况

### 1. API设计器 (ApiDesigner)

**存储位置：**
- `localStorage` - `api_designer_defs` (API定义)
- `localStorage` - `api_environments` (环境配置)
- `localStorage` - `api_current_environment` (当前环境)

**后端支持：**
- ❌ 无后端API接口
- ❌ 无数据同步服务

**问题：**
- 数据仅存储在浏览器本地，换设备或清除缓存会丢失
- 无法多用户协作
- 无版本控制

**代码位置：**
- `frontend/src/pages/ApiDesigner.tsx` (行 77-100)

---

### 2. 数据模型 (DataModels)

**存储位置：**
- `localStorage` - `data_models`

**后端支持：**
- ✅ 有后端API接口 (`backend/src/routes/dataModels.ts`)
- ✅ 有数据同步服务 (`frontend/src/services/dataSync.ts`)

**问题：**
- 数据同步服务存在但未在页面中调用
- 后端数据存储在内存中，重启会丢失

**代码位置：**
- `frontend/src/pages/DataModels.tsx`
- `frontend/src/services/dataSync.ts` (行 136-212)

---

### 3. 项目管理 (Projects)

**存储位置：**
- `localStorage` - `projects` (仅在dataSync服务中使用)
- 页面使用硬编码的示例数据

**后端支持：**
- ✅ 有后端API接口 (`backend/src/routes/projects.ts`)
- ✅ 有数据同步服务 (`frontend/src/services/dataSync.ts`)
- ❌ 页面未使用后端API

**问题：**
- `Projects.tsx` 页面使用硬编码数据，未从localStorage或后端加载
- 创建/删除项目后数据不会持久化
- 后端数据存储在内存中，重启会丢失

**代码位置：**
- `frontend/src/pages/Projects.tsx` (行 13-21，使用硬编码数据)
- `backend/src/routes/projects.ts` (行 7-17，内存存储)

---

### 4. 可视化编辑器 (Editor)

**存储位置：**
- ❌ 无持久化存储
- 使用Zustand store (`frontend/src/stores/editorStore.ts`)，仅内存存储

**后端支持：**
- ✅ 有后端API接口 (`backend/src/routes/projects.ts` - 保存组件接口)
- ❌ 编辑器未调用保存接口

**问题：**
- **严重问题**：编辑器组件数据完全没有持久化
- 刷新页面会丢失所有编辑内容
- 有保存接口但未集成

**代码位置：**
- `frontend/src/stores/editorStore.ts` (无持久化逻辑)
- `backend/src/routes/projects.ts` (行 108-124，保存组件接口)

---

### 5. 工作流 (Workflows)

**存储位置：**
- `localStorage` - 工作流实例 (`workflowInstances`)

**后端支持：**
- ✅ 有后端API接口 (`backend/src/routes/workflows.ts`)
- ❌ 页面未使用后端API

**问题：**
- 工作流定义（节点、连线）未持久化
- 仅工作流实例保存到localStorage
- 后端API存在但未使用

**代码位置：**
- `frontend/src/utils/workflowEngine.ts` (行 353-365)
- `frontend/src/pages/Workflows.tsx` (行 72-76)

---

### 6. 表单设计器 (FormDesigner)

**存储位置：**
- `localStorage` - `savedForms` (表单配置)
- `localStorage` - `formSubmissions` (表单提交数据)

**后端支持：**
- ❌ 无后端API接口
- ❌ 无数据同步服务

**问题：**
- 数据仅存储在浏览器本地
- 无法多用户协作
- 无版本控制

**代码位置：**
- `frontend/src/pages/FormDesigner.tsx` (行 114, 129)

---

### 7. 环境配置 (API Environments)

**存储位置：**
- `localStorage` - `api_environments`
- `localStorage` - `api_current_environment`

**后端支持：**
- ❌ 无后端API接口

**问题：**
- 环境配置仅存储在本地
- 无法团队共享环境配置

---

### 8. 其他配置

**预览模拟数据：**
- `localStorage` - `previewMockData`

**数据绑定：**
- 从 `localStorage` - `dataModels` 读取（但未持久化绑定关系）

---

## 后端存储情况

### 当前实现

所有后端路由使用**内存存储**（数组变量），存在以下问题：

1. **数据丢失**：服务器重启后所有数据丢失
2. **无持久化**：未使用数据库
3. **单实例限制**：无法水平扩展

### 后端路由列表

- `backend/src/routes/projects.ts` - 项目数据（内存）
- `backend/src/routes/dataModels.ts` - 数据模型（内存）
- `backend/src/routes/workflows.ts` - 工作流（内存）
- `backend/src/routes/components.ts` - 组件（内存）
- `backend/src/routes/ai.ts` - AI助手（无存储需求）

---

## 问题总结

### 🔴 严重问题

1. **编辑器组件数据未持久化**
   - 刷新页面会丢失所有编辑内容
   - 有保存接口但未集成

2. **项目管理页面未使用后端API**
   - 使用硬编码数据
   - 创建/删除操作不会持久化

3. **后端数据存储在内存中**
   - 服务器重启后数据丢失
   - 无法持久化保存

### 🟡 中等问题

4. **API设计器无后端支持**
   - 数据仅存储在localStorage
   - 无法多用户协作

5. **工作流定义未持久化**
   - 仅实例保存，定义丢失

6. **表单设计器无后端支持**
   - 数据仅存储在localStorage

7. **数据同步服务未使用**
   - `dataSync.ts` 服务存在但未在页面中调用

### 🟢 轻微问题

8. **环境配置无后端支持**
   - 仅影响团队协作，不影响核心功能

---

## 改进建议

### 优先级1：紧急修复

#### 1. 集成数据库存储

**方案：** 使用SQLite（开发）或PostgreSQL（生产）

```typescript
// 示例：使用Prisma ORM
// backend/prisma/schema.prisma
model Project {
  id        String   @id @default(uuid())
  name      String
  description String?
  components Json     // 存储组件树
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model ApiDefinition {
  id          String   @id @default(uuid())
  name        String
  path        String
  method      String
  headers     Json?
  mockResponse String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}
```

**实施步骤：**
1. 安装Prisma：`npm install prisma @prisma/client`
2. 初始化数据库：`npx prisma init`
3. 定义Schema
4. 迁移数据库：`npx prisma migrate dev`
5. 更新后端路由使用Prisma Client

#### 2. 修复编辑器持久化

**方案：** 在编辑器Store中添加自动保存功能

```typescript
// frontend/src/stores/editorStore.ts
export const useEditorStore = create<EditorStore>((set, get) => ({
  // ... 现有代码
  
  // 添加保存方法
  saveProject: async (projectId: string) => {
    const { components } = get();
    try {
      await projectAPI.saveComponents(projectId, components);
      message.success('项目已保存');
    } catch (error) {
      message.error('保存失败');
    }
  },
  
  // 添加加载方法
  loadProject: async (projectId: string) => {
    try {
      const project = await projectAPI.getById(projectId);
      set({ components: project.components || [] });
      message.success('项目已加载');
    } catch (error) {
      message.error('加载失败');
    }
  },
}));
```

**在Editor页面集成：**
```typescript
// frontend/src/pages/Editor.tsx
useEffect(() => {
  const projectId = params.projectId;
  if (projectId) {
    useEditorStore.getState().loadProject(projectId);
  }
}, [params.projectId]);

// 自动保存（防抖）
useEffect(() => {
  const timer = setTimeout(() => {
    const projectId = params.projectId;
    if (projectId) {
      useEditorStore.getState().saveProject(projectId);
    }
  }, 2000); // 2秒后自动保存
  
  return () => clearTimeout(timer);
}, [components]);
```

#### 3. 修复项目管理页面

**方案：** 使用后端API替换硬编码数据

```typescript
// frontend/src/pages/Projects.tsx
useEffect(() => {
  const loadProjects = async () => {
    try {
      const data = await projectAPI.getAll();
      setProjects(data);
    } catch (error) {
      message.error('加载项目失败');
    }
  };
  loadProjects();
}, []);

const handleCreate = async () => {
  try {
    const values = await form.validateFields();
    const newProject = await projectAPI.create(values);
    setProjects([...projects, newProject]);
    message.success('创建成功');
  } catch (error) {
    message.error('创建失败');
  }
};
```

### 优先级2：重要改进

#### 4. 为API设计器添加后端支持

**创建后端路由：**
```typescript
// backend/src/routes/apiDefinitions.ts
router.get('/', async (req, res) => {
  const apis = await prisma.apiDefinition.findMany({
    where: { userId: req.user.id }
  });
  res.json({ success: true, data: apis });
});

router.post('/', async (req, res) => {
  const api = await prisma.apiDefinition.create({
    data: { ...req.body, userId: req.user.id }
  });
  res.json({ success: true, data: api });
});
```

#### 5. 为表单设计器添加后端支持

类似API设计器，创建表单定义的后端路由和数据库模型。

#### 6. 启用数据同步服务

在应用启动时调用数据同步服务：

```typescript
// frontend/src/App.tsx
useEffect(() => {
  // 启动自动同步（每5分钟）
  const stopSync = dataSyncService.startAutoSync(5 * 60 * 1000);
  
  // 初始同步
  dataSyncService.syncProjects().catch(console.error);
  dataSyncService.syncDataModels().catch(console.error);
  
  return () => stopSync();
}, []);
```

### 优先级3：优化改进

#### 7. 添加版本控制

为项目、API定义等添加版本历史：

```typescript
model ProjectVersion {
  id        String   @id @default(uuid())
  projectId String
  version   Int
  components Json
  createdAt DateTime @default(now())
  createdBy String
}
```

#### 8. 添加用户认证

实现用户登录，关联数据到用户：

```typescript
model User {
  id        String   @id @default(uuid())
  email     String   @unique
  projects  Project[]
  apiDefinitions ApiDefinition[]
}
```

#### 9. 添加数据导出/导入

提供JSON格式的导出/导入功能，便于备份和迁移。

---

## 实施计划

### 第一阶段（1-2周）：紧急修复

1. ✅ 集成数据库（SQLite/PostgreSQL + Prisma）
2. ✅ 修复编辑器持久化
3. ✅ 修复项目管理页面
4. ✅ 更新所有后端路由使用数据库

### 第二阶段（2-3周）：重要改进

5. ✅ 为API设计器添加后端支持
6. ✅ 为表单设计器添加后端支持
7. ✅ 启用数据同步服务
8. ✅ 添加工作流定义持久化

### 第三阶段（3-4周）：优化改进

9. ✅ 添加版本控制
10. ✅ 添加用户认证
11. ✅ 添加数据导出/导入
12. ✅ 性能优化和缓存策略

---

## 总结

当前项目存在严重的持久化存储问题：

- **编辑器数据完全未持久化**（最严重）
- **后端数据存储在内存中**（重启丢失）
- **多个模块仅使用localStorage**（无法协作）

建议立即实施第一阶段修复，确保核心功能（编辑器、项目管理）的数据持久化，然后逐步完善其他模块。

