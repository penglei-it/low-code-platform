# 构建问题排查指南

本文档帮助您解决构建过程中遇到的常见问题。

## 常见构建错误及解决方案

### 1. 后端构建失败

#### 错误：找不到模块 '@prisma/client'

**解决方案**：
```bash
cd backend
npx prisma generate
npm run build
```

#### 错误：TypeScript 类型错误

**解决方案**：
1. 检查 `tsconfig.json` 配置是否正确
2. 检查导入路径是否正确
3. 运行 `npm run lint` 查看详细错误信息

#### 错误：找不到模块或文件

**解决方案**：
1. 删除 `node_modules` 和 `package-lock.json`
2. 重新安装依赖：`npm install`
3. 重新生成 Prisma Client：`npx prisma generate`

### 2. 前端构建失败

#### 错误：Vite 构建失败

**解决方案**：
1. 检查 `vite.config.ts` 配置
2. 检查环境变量是否正确设置
3. 查看详细错误信息：
   ```bash
   cd frontend
   npm run build -- --debug
   ```

#### 错误：TypeScript 类型错误

**解决方案**：
1. 检查 `tsconfig.json` 配置
2. 运行类型检查：`npx tsc --noEmit`
3. 查看详细错误信息

#### 错误：找不到模块或包

**解决方案**：
1. 删除 `node_modules` 和 `package-lock.json`
2. 清除缓存：`npm cache clean --force`
3. 重新安装依赖：`npm install`

### 3. Docker 构建失败

#### 错误：npm ci 失败

**可能原因**：
- `package-lock.json` 与 `package.json` 不匹配
- 网络问题导致依赖下载失败

**解决方案**：
```bash
# 在本地重新生成 package-lock.json
cd backend  # 或 frontend
rm -rf node_modules package-lock.json
npm install
git add package-lock.json
git commit -m "Update package-lock.json"
```

#### 错误：Prisma Client 生成失败

**解决方案**：
确保 Dockerfile 中正确复制了 `prisma` 目录：
```dockerfile
COPY prisma ./prisma/
```

#### 错误：构建阶段缺少文件

**解决方案**：
1. 检查 `.dockerignore` 文件，确保没有忽略必要的文件
2. 确保 Dockerfile 中按正确顺序复制文件

### 4. 环境变量问题

#### 前端构建时环境变量未生效

**原因**：Vite 的环境变量需要在构建时设置，不能运行时修改。

**解决方案**：
1. 创建 `.env.production` 文件：
   ```env
   VITE_API_BASE_URL=http://your-backend-url/api
   ```
2. 在 Dockerfile 中使用构建参数：
   ```dockerfile
   ARG VITE_API_BASE_URL
   ENV VITE_API_BASE_URL=$VITE_API_BASE_URL
   ```

## 完整构建流程

### 本地构建

1. **安装依赖**
   ```bash
   # 后端
   cd backend
   npm install
   npx prisma generate
   
   # 前端
   cd frontend
   npm install
   ```

2. **构建项目**
   ```bash
   # 后端
   cd backend
   npm run build
   
   # 前端
   cd frontend
   npm run build
   ```

### Docker 构建

1. **测试本地构建**
   ```bash
   # 先确保本地构建成功
   cd backend
   npm run build
   
   cd ../frontend
   npm run build
   ```

2. **构建 Docker 镜像**
   ```bash
   # 后端
   cd backend
   docker build -t low-code-backend .
   
   # 前端
   cd frontend
   docker build -t low-code-frontend .
   ```

3. **使用 Docker Compose**
   ```bash
   docker-compose build
   docker-compose up -d
   ```

## 调试技巧

### 1. 查看详细构建日志

```bash
# 后端
cd backend
npm run build -- --verbose

# 前端
cd frontend
npm run build -- --debug
```

### 2. 检查依赖版本

```bash
npm list --depth=0
```

### 3. 清理并重新构建

```bash
# 清理构建产物
rm -rf backend/dist frontend/dist

# 清理依赖（谨慎使用）
rm -rf backend/node_modules frontend/node_modules
rm -rf backend/package-lock.json frontend/package-lock.json

# 重新安装和构建
npm install
npm run build
```

### 4. 检查 TypeScript 配置

```bash
# 后端
cd backend
npx tsc --showConfig

# 前端
cd frontend
npx tsc --showConfig
```

## 获取帮助

如果以上方案都无法解决问题：

1. **查看完整错误日志**
   - 复制完整的错误信息
   - 检查错误堆栈跟踪

2. **检查环境**
   ```bash
   node --version  # 应该 >= 18.0.0
   npm --version   # 应该 >= 9.0.0
   ```

3. **测试最小示例**
   - 创建最小可复现示例
   - 隔离问题范围

4. **查看项目文档**
   - 阅读 `部署说明.md`
   - 查看项目 README

## 常见错误代码

### TS2307: Cannot find module

**原因**：模块路径错误或依赖未安装

**解决**：
1. 检查导入路径
2. 确保依赖已安装
3. 检查 `tsconfig.json` 的路径配置

### TS2322: Type is not assignable

**原因**：类型不匹配

**解决**：
1. 检查类型定义
2. 使用类型断言（谨慎使用）
3. 修正类型定义

### ERR_MODULE_NOT_FOUND

**原因**：模块找不到

**解决**：
1. 检查文件路径
2. 检查文件扩展名（.js/.ts）
3. 检查 `package.json` 的 `type` 字段

## 性能优化

### 加速构建

1. **使用缓存**
   - Docker 构建时使用缓存层
   - 保留 `node_modules` 不清理

2. **并行构建**
   ```bash
   # 使用 concurrently
   npm run build:frontend & npm run build:backend
   ```

3. **增量构建**
   - TypeScript 增量编译
   - Vite 使用缓存

