# 解决代理错误 (ECONNREFUSED)

## 问题描述

前端服务运行正常，但出现以下错误：
```
[vite] http proxy error: /api/data-models
AggregateError [ECONNREFUSED]
```

## 原因

1. **后端服务未运行** - 端口 3001 上没有服务在监听
2. **Vite Preview 模式限制** - `vite preview` 不支持 `server.proxy` 配置

## 解决方案

### ✅ 方案一：确保后端服务运行（推荐）

1. **启动后端服务**
   ```bash
   cd backend
   npm start
   ```

2. **验证后端服务**
   访问：http://localhost:3001/api/health
   
   应该返回：`{"status":"ok","message":"Low-code platform API is running"}`

3. **重新启动前端服务**
   ```bash
   cd frontend
   npm run preview -- --host 0.0.0.0
   ```

### ✅ 方案二：配置环境变量（如果后端在不同地址）

1. **创建环境变量文件**
   
   创建 `frontend/.env.production`：
   ```env
   VITE_API_BASE_URL=http://<后端IP>:3001/api
   ```

2. **重新构建前端**
   ```bash
   cd frontend
   npm run build
   npm run preview -- --host 0.0.0.0
   ```

### ✅ 方案三：使用快速启动脚本

运行：
```bash
快速启动服务.bat
```

或：

```bash
启动完整服务.bat
```

这些脚本会自动：
1. 检查后端服务状态
2. 如果未运行，自动启动后端
3. 启动前端服务

### ✅ 方案四：使用修复脚本

运行：
```bash
修复代理问题.bat
```

这个脚本会：
1. 检查后端服务
2. 如果未运行，自动启动
3. 测试后端连接
4. 提供详细的修复建议

## 验证步骤

1. **检查后端服务**
   ```bash
   # Windows
   netstat -ano | findstr :3001
   
   # 应该看到端口被占用
   ```

2. **测试后端 API**
   ```bash
   curl http://localhost:3001/api/health
   # 或浏览器访问：http://localhost:3001/api/health
   ```

3. **检查前端服务**
   - 访问：http://localhost:4173
   - 打开浏览器开发者工具（F12）
   - 查看 Network 标签
   - 检查 API 请求是否成功

## 常见问题

### Q: 后端启动失败？

**检查**：
1. 数据库是否已初始化
   ```bash
   cd backend
   npx prisma generate
   npx prisma migrate dev --name init
   ```

2. 端口是否被占用
   ```bash
   netstat -ano | findstr :3001
   ```

### Q: 前端仍无法连接后端？

**检查**：
1. 后端是否监听在 `0.0.0.0:3001`（不是 `localhost`）
2. 防火墙是否允许端口 3001
3. 环境变量 `VITE_API_BASE_URL` 是否正确设置

### Q: 如何在生产环境部署？

**推荐使用 Nginx 反向代理**：

1. **Nginx 配置** (`/etc/nginx/sites-available/low-code-platform`)：
   ```nginx
   server {
       listen 80;
       server_name your-domain.com;
       
       # 前端
       location / {
           proxy_pass http://localhost:4173;
           proxy_http_version 1.1;
           proxy_set_header Upgrade $http_upgrade;
           proxy_set_header Connection 'upgrade';
           proxy_set_header Host $host;
           proxy_cache_bypass $http_upgrade;
       }
       
       # 后端 API
       location /api {
           proxy_pass http://localhost:3001;
           proxy_http_version 1.1;
           proxy_set_header Host $host;
           proxy_set_header X-Real-IP $remote_addr;
           proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
       }
   }
   ```

2. **或者使用 Docker Compose**（已配置好）

## 快速命令

```bash
# 启动后端
cd backend && npm start

# 启动前端（新终端）
cd frontend && npm run preview -- --host 0.0.0.0

# 或者使用脚本
快速启动服务.bat
```

## 成功标志

✅ 后端服务输出：`Server is running on http://0.0.0.0:3001`
✅ 后端健康检查：访问 http://localhost:3001/api/health 返回正常
✅ 前端服务输出：显示 Local 和 Network 地址
✅ 浏览器访问前端，Network 标签中的 API 请求成功（状态码 200）

